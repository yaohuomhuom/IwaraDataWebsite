<template>
    <div class="">
        <bar-echarts ref='bar' class="div_all" />
    </div>
</template>

<script>
    import BarEcharts from '../../../components/bar/index.vue';
    //import data from "../../../api/file.js";
    export default {
        components: {
            BarEcharts
        },
        mounted() {
            this.$refs.bar.setToolTip('axis',function (params) {
                        var string =''
                        for (var x in params) {
                            if(params[x].data.url){
                                 string += "链接:" + params[x].data.url + '<br/>'
                            }
                            if(params[x].data.view){
                                 string += "播放量:" + params[x].data.view + '<br/>' 
                            }
                            if(params[x].data.hour_view){
                                 string += "每小时增长量:" + params[x].data.hour_view+ '<br/>' ;
                            }
                        }
                        return string;
                    });
            this.$refs.bar.setToolBox({ 
                myTool1:{
                    show:true,
                    title:'日榜数据',
                    icon:"path://M408.222897 789.115586v-35.345655h217.15862v34.886621h33.474207V388.378483h-283.68331v400.737103h33.050483z m217.15862-237.779862h-217.15862v-130.824827h217.15862v130.824827z m0 170.301793h-217.15862v-138.169379h217.15862v138.169379z M917.645241 144.772414a70.62069 70.62069 0 0 1 70.62069 70.620689v681.489656a70.62069 70.62069 0 0 1-70.62069 70.620689H94.384552a70.62069 70.62069 0 0 1-70.62069-70.620689V215.393103a70.62069 70.62069 0 0 1 70.62069-70.620689h823.260689z m0 45.903448H94.384552a24.717241 24.717241 0 0 0-24.50538 21.362759l-0.211862 3.354482v681.489656a24.717241 24.717241 0 0 0 21.362759 24.505379l3.354483 0.211862h823.260689a24.717241 24.717241 0 0 0 24.50538-21.362759l0.211862-3.354482V215.393103a24.717241 24.717241 0 0 0-21.362759-24.505379l-3.354483-0.211862z M312.214069 31.249655a22.951724 22.951724 0 0 1 22.704552 19.561931l0.247172 3.389793v180.824276a22.951724 22.951724 0 0 1-45.656276 3.389793l-0.247172-3.389793v-180.788965a22.951724 22.951724 0 0 1 22.951724-22.951724zM691.023448 31.249655a22.951724 22.951724 0 0 1 22.704552 19.561931l0.247172 3.389793v180.824276a22.951724 22.951724 0 0 1-45.656275 3.389793l-0.247173-3.389793v-180.788965a22.951724 22.951724 0 0 1 22.951724-22.951724z",
                    onclick:()=>{
                           this.getDay();                                  
                       }
                    },
                myTool2:{
                    show:true,
                    title:'月榜数据(前十)',
                    icon:"path://M371.959172 792.328828c29.837241-39.017931 47.315862-88.134621 52.788966-147.809104h197.843862v91.347862c0 13.312-5.508414 20.197517-16.066207 20.197517-17.44331 0-36.722759-0.918069-57.838345-1.836137l9.18069 32.591448h59.215448c25.705931 0 39.017931-13.312 39.017931-39.476966V388.378483h-263.026758v224.008827c-0.918069 63.346759-16.066207 115.67669-46.362483 156.989793l25.246896 22.951725z m250.632828-291.945931h-195.972414v-80.331035h195.972414v80.331035z m0 113.381517h-195.972414v-82.626207h195.972414v82.626207z M917.645241 144.772414a70.62069 70.62069 0 0 1 70.62069 70.620689v681.489656a70.62069 70.62069 0 0 1-70.62069 70.620689H94.384552a70.62069 70.62069 0 0 1-70.62069-70.620689V215.393103a70.62069 70.62069 0 0 1 70.62069-70.620689h823.260689z m0 45.903448H94.384552a24.717241 24.717241 0 0 0-24.50538 21.362759l-0.211862 3.354482v681.489656a24.717241 24.717241 0 0 0 21.362759 24.505379l3.354483 0.211862h823.260689a24.717241 24.717241 0 0 0 24.50538-21.362759l0.211862-3.354482V215.393103a24.717241 24.717241 0 0 0-21.362759-24.505379l-3.354483-0.211862z M312.214069 31.249655a22.951724 22.951724 0 0 1 22.704552 19.561931l0.247172 3.389793v180.824276a22.951724 22.951724 0 0 1-45.656276 3.389793l-0.247172-3.389793v-180.788965a22.951724 22.951724 0 0 1 22.951724-22.951724zM691.023448 31.249655a22.951724 22.951724 0 0 1 22.704552 19.561931l0.247172 3.389793v180.824276a22.951724 22.951724 0 0 1-45.656275 3.389793l-0.247173-3.389793v-180.788965a22.951724 22.951724 0 0 1 22.951724-22.951724z",
                    onclick:()=>{
                          this.getMonth();
                          this.sortData("down",(v,i)=>{return i<10;});                                     
                        }
                    },
                myTool3:{
                    show:true,
                    title:'月榜数据(3w)',
                    icon:"path://M371.959172 792.328828c29.837241-39.017931 47.315862-88.134621 52.788966-147.809104h197.843862v91.347862c0 13.312-5.508414 20.197517-16.066207 20.197517-17.44331 0-36.722759-0.918069-57.838345-1.836137l9.18069 32.591448h59.215448c25.705931 0 39.017931-13.312 39.017931-39.476966V388.378483h-263.026758v224.008827c-0.918069 63.346759-16.066207 115.67669-46.362483 156.989793l25.246896 22.951725z m250.632828-291.945931h-195.972414v-80.331035h195.972414v80.331035z m0 113.381517h-195.972414v-82.626207h195.972414v82.626207z M917.645241 144.772414a70.62069 70.62069 0 0 1 70.62069 70.620689v681.489656a70.62069 70.62069 0 0 1-70.62069 70.620689H94.384552a70.62069 70.62069 0 0 1-70.62069-70.620689V215.393103a70.62069 70.62069 0 0 1 70.62069-70.620689h823.260689z m0 45.903448H94.384552a24.717241 24.717241 0 0 0-24.50538 21.362759l-0.211862 3.354482v681.489656a24.717241 24.717241 0 0 0 21.362759 24.505379l3.354483 0.211862h823.260689a24.717241 24.717241 0 0 0 24.50538-21.362759l0.211862-3.354482V215.393103a24.717241 24.717241 0 0 0-21.362759-24.505379l-3.354483-0.211862z M312.214069 31.249655a22.951724 22.951724 0 0 1 22.704552 19.561931l0.247172 3.389793v180.824276a22.951724 22.951724 0 0 1-45.656276 3.389793l-0.247172-3.389793v-180.788965a22.951724 22.951724 0 0 1 22.951724-22.951724zM691.023448 31.249655a22.951724 22.951724 0 0 1 22.704552 19.561931l0.247172 3.389793v180.824276a22.951724 22.951724 0 0 1-45.656275 3.389793l-0.247173-3.389793v-180.788965a22.951724 22.951724 0 0 1 22.951724-22.951724z",
                    onclick:()=>{
                           this.getMonth((v)=>{return v.view>30000});                                  
                        }
                    },
                myTool5:{
                    show:true,
                    title:'排序',
                    icon:"path://M393.841 0c-19.262 0-34.889 15.604-34.889 34.889v869.407L138.92 684.265c-13.628-13.629-35.707-13.606-49.335 0-13.605 13.628-13.628 35.706 0 49.357l279.612 279.589c0.022 0.022 0.045 0.022 0.068 0.045a34.805 34.805 0 0 0 11.266 7.496c0.272 0.091 0.522 0.137 0.795 0.228 3.816 1.476 7.927 2.362 12.266 2.407 0.182 0 0.364-0.022 0.545-0.022 4.293-0.022 8.381-0.909 12.175-2.362 0.295-0.113 0.59-0.159 0.909-0.272a35.124 35.124 0 0 0 11.016-7.314c0.091-0.091 0.205-0.113 0.295-0.204s0.114-0.204 0.182-0.296a34.762 34.762 0 0 0 7.359-11.062c0.091-0.25 0.136-0.499 0.227-0.749 1.5-3.885 2.408-8.063 2.408-12.471 0-0.045 0.023-0.091 0.023-0.136V34.889C428.73 15.604 413.103 0 393.841 0zM932.258 289.901L652.646 10.29c-0.023-0.045-0.046-0.045-0.068-0.045a35.188 35.188 0 0 0-11.267-7.496c-0.272-0.091-0.522-0.136-0.795-0.227A34.373 34.373 0 0 0 628.25 0.114h-0.545c-4.293 0.045-8.382 0.908-12.175 2.362-0.295 0.137-0.591 0.182-0.908 0.318-4.135 1.681-7.859 4.179-11.017 7.269-0.091 0.091-0.205 0.136-0.296 0.227s-0.113 0.182-0.182 0.272c-3.111 3.18-5.633 6.905-7.359 11.084-0.091 0.227-0.136 0.5-0.227 0.727-1.499 3.907-2.408 8.086-2.408 12.493 0 0.045-0.022 0.091-0.022 0.136v953.631c0 19.262 15.627 34.89 34.889 34.89s34.89-15.628 34.89-34.89V119.227l220.031 220.01c13.629 13.628 35.707 13.628 49.336 0 13.606-13.63 13.629-35.708 0.001-49.336z",
                    onclick:()=>{
                           this.sortData("down");                                  
                        }
                    },
                myTool6:{
                    show:true,
                    title:'每小时增长率',
                    icon:"M141.2 894V115.3h-39V933h817.7v-39z M227.4 855.1h61.1c15.4 0 27.9-12.5 27.9-27.9V668.8c0-15.4-12.5-27.9-27.9-27.9h-61.1c-15.4 0-27.9 12.5-27.9 27.9v158.4c0 15.4 12.5 27.9 27.9 27.9z m11.1-175.2h38.9v136.3h-38.9V679.9zM409.1 543.6c-15.4 0-27.9 12.5-27.9 27.9v255.8c0 15.4 12.5 27.9 27.9 27.9h61.1c15.4 0 27.9-12.5 27.9-27.9V571.5c0-15.4-12.5-27.9-27.9-27.9h-61.1z m50.1 272.5h-38.9V582.5h38.9v233.6zM590.8 446.2c-15.4 0-27.9 12.5-27.9 27.9v353.1c0 15.4 12.5 27.9 27.9 27.9h61.1c15.4 0 27.9-12.5 27.9-27.9V474.1c0-15.4-12.5-27.9-27.9-27.9h-61.1z m50.1 370H602v-331h38.9v331zM744.7 376.8v450.5c0 15.4 12.5 27.9 27.9 27.9h61.1c15.4 0 27.9-12.5 27.9-27.9V376.8c-0.1-15.4-12.5-27.9-27.9-27.9h-61.1c-15.4 0-27.9 12.5-27.9 27.9z m39 11h38.9v428.3h-38.9V387.8zM219 563.1c3.8 0 7.7-1.1 11-3.4l249.3-171.8h123.6c8.9 0 17.5-3.8 23.7-10.4l157.1-171.4V271c0 10.8 8.7 19.5 19.5 19.5s19.5-8.7 19.5-19.5V134.7H686.3c-10.8 0-19.5 8.7-19.5 19.5s8.7 19.5 19.5 19.5h74.2L599.9 348.9H477c-7.5 0-14.6 2.6-20.3 7.2L208 527.6c-8.9 6.1-11.1 18.2-5 27.1 3.7 5.4 9.8 8.4 16 8.4z",
                    onclick:()=>{
                        this.getHourUp();
                        this.sortData("down",(v,i)=>{return i<10;});  
                           /* this.$refs.bar.setTempList("iw",(v)=>{
                                var now_time =+ new Date();
                                var upload_time =+ new Date(v.time);
                                var time_hour = (now_time - upload_time)/(1000*60*60);
                                return Math.floor(v.value/time_hour);   
                            },'line')  */                             
                        }
                    },
                myTool7:{
                    show:true,
                    title:'样式更改',
                    icon:"path://M735.085714 796.233143c0-15.579429 12.726857-28.818286 28.891429-28.818286h230.4a29.257143 29.257143 0 0 1 28.818286 28.818286 28.891429 28.891429 0 0 1-28.745143 28.818286h-230.473143a29.257143 29.257143 0 0 1-28.818286-28.818286z m0-127.926857c0-15.506286 12.726857-28.745143 28.891429-28.745143h230.4a29.257143 29.257143 0 0 1 28.818286 28.745143 28.891429 28.891429 0 0 1-28.745143 28.818285h-230.473143a29.257143 29.257143 0 0 1-28.818286-28.818285z m28.891429-156.672h230.4a29.257143 29.257143 0 0 1 28.818286 28.818285 28.891429 28.891429 0 0 1-28.745143 28.818286h-230.473143a29.257143 29.257143 0 0 1-28.818286-28.818286 29.257143 29.257143 0 0 1 28.818286-28.818285zM901.632 0c50.176 0 122.148571 49.005714 121.051429 127.926857 1.097143 35.693714-13.897143 66.267429-42.642286 96.768-216.064 189.586286-300.178286 227.620571-306.468572 285.257143-5.266286 45.494857-1.828571 472.356571-2.925714 478.134857a39.497143 39.497143 0 0 1-5.778286 22.454857c-18.432 18.432-37.449143 12.141714-47.250285 4.022857-72.045714-58.733714-232.740571-189.513143-251.172572-228.132571-21.357714-41.472-13.238857-126.756571-13.238857-276.48 0-34.084571-253.513143-235.154286-308.297143-285.257143C31.744 210.285714 0 181.540571 0 128 0 49.590857 63.926857 0 134.802286 0h766.829714zM76.068571 164.790857c1.682286 2.340571 4.022857 5.12 6.875429 8.045714l8.630857 8.630858-3.437714-3.437715a9235.017143 9235.017143 0 0 0 147.529143 125.074286l14.921143 12.653714c134.290286 115.2 167.131429 147.456 167.131428 194.706286 0 27.648 0 51.273143-0.585143 88.137143-1.755429 114.102857 0 145.773714 8.045715 161.353143 3.437714 6.875429 47.835429 49.517714 108.324571 101.961143l17.261714 14.409142c32.914286 27.648 57.051429 54.125714 57.051429 51.273143v-179.785143c0-139.995429 0.585143-221.184 3.437714-244.297142 1.755429-13.165714 5.193143-25.892571 10.386286-38.034286 15.579429-35.108571 40.96-59.245714 105.472-111.689143l89.234286-72.045714c40.374857-34.596571 81.261714-69.12 121.636571-104.886857l-4.608 4.096c19.017143-20.187429 25.892571-35.181714 25.307429-53.613715 0.585143-33.426286-32.182857-63.341714-57.051429-63.341714H134.802286c-41.472 0-70.875429 26.477714-70.875429 63.926857 0 14.994286 4.022857 25.892571 12.141714 36.864z",
                    onclick:()=>{
                          if(this.theme == 'default'){
                              this.$refs.bar.setSeriesStyle("iw","bar_pink");
                              this.$refs.bar.setChartStyle("chart_pink"); 
                              this.theme = 'pink';
                          }else if(this.theme == 'pink'){
                              this.$refs.bar.setSeriesStyle("iw","bar_blue");
                              this.$refs.bar.setChartStyle("chart_blue"); 
                              this.theme = 'blue';
                              
                          }else if(this.theme == "blue"){
                              this.$refs.bar.setSeriesStyle("iw","bar_default");
                              this.$refs.bar.setChartStyle("chart_default"); 
                              this.theme = 'default';
                          }                   
                        }
                    }, 
            });
            this.ws_int();
        },
        data(){
            return{
                day:[],
                month:[],
                show_list_name:"",
                theme:"default"
            }
        },
        computed:{
            hour_up:{
                get(){
                    var json = JSON.parse(JSON.stringify(this.month));
                    return json.map((v)=>{
                         var now_time =+ new Date();
                         var upload_time =+ new Date(v.time);
                         var time_hour = (now_time - upload_time)/(1000*60*60);
                         //v.view = Math.floor(v.view/time_hour); 
                         v.hour_view = Math.floor(v.view/time_hour); 
                         return v;
                     })
                }
            }
        },
        methods: {
            ws_int() {
                if (typeof(WebSocket) === "undefined") {
                    alert("您的浏览器不支持socket");
                } else {
                    var socket = new WebSocket('ws://localhost:3000/ws?uid=123');
                    var wsping = setInterval(function() {
                        socket.send("ping")
                    }, 5000);
                    this.get_prototype.$ws = {};
                    this.get_prototype.$ws.ws = socket;
                    this.get_prototype.$ws.wsping = wsping;
                    socket.onopen = this.ws_onpen;
                    socket.onmessage = this.ws_message;
                    socket.onclose = this.ws_close;
                }
            },
            ws_onpen({target}){
                target.send(JSON.stringify({name:"day"}));
            },
            ws_message(msg) {
                if (msg.data == "pong") {
                    return;
                }
                var list_data = JSON.parse(msg.data);
                if(list_data.name == "day"){
                    this.day = list_data.list.reverse();
                }
                if(list_data.name == "month"){
                    this.month = list_data.list.reverse();
                }
                if(list_data.name == "init"){
                    this.month = list_data.month.reverse();
                    this.day = list_data.day.reverse();
                    this.initData(this.day);   
                }
            },
            ws_close() {
                clearInterval(this.$ws.wsping);
            },
            initData(int_data) {
                this.$refs.bar.initDataByObject(int_data, {
                    x: "time",
                    type:"bar",
                    y: 'view'
                }, 'iw');
            },
            getMonth(func){
               this.show_list_name = "month";
               if(func){
                   this.setData(this.month.filter(func));
               }else{
                   this.setData(this.month);   
               }
            },
            getDay(func){
               this.show_list_name = "day";
               if(func){
                   this.setData(this.day.filter(func));
               }else{
                   this.setData(this.day);   
               }
            },
            getHourUp(func){
               this.show_list_name = "HourUp";
               if(func){
                   this.$refs.bar.setDataByObject(this.hour_up.filter(func), {
                       x: "time",
                       y: 'hour_view'
                   }, 'iw');
               }else{
                   this.$refs.bar.setDataByObject(this.hour_up, {
                       x: "time",
                       y: 'hour_view'
                   }, 'iw');
               }
            },
            setData(set_data) {
                this.$refs.bar.setDataByObject(set_data, {
                    x: "time",
                    y: 'view'
                }, 'iw');
            },
            sortData(way,func) {
                this.$refs.bar.sortData("iw", way,func);
            },
            backData() {
                this.$refs.bar.restartData("iw");
            }
        }
    }
</script>

<style>
</style>
