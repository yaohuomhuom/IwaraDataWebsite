<template>
    <div class="div_all">
        <bar-echarts ref='bar' class="div_all" />
    </div>
</template>

<script>
    import BarEcharts from '../../../components/bar/index.vue';
    //import data from "../../../api/file.js";
    export default {
        components: {
            BarEcharts
        },
        mounted() {
            this.$refs.bar.setToolTip('axis',function (params) {
                            console.log(params);
                        for (var x in params) {
                            return "播放量:" + params[x].data.value + '<br/>' +
                                   "链接:" + params[x].data.url + '<br/>' +
                                   "标题:" + params[x].data.title
                        }
                    });
            this.$refs.bar.setToolBox({ 
                myTool1:{
                    show:true,
                    title:'日榜数据',
                    icon:"path://M408.222897 789.115586v-35.345655h217.15862v34.886621h33.474207V388.378483h-283.68331v400.737103h33.050483z m217.15862-237.779862h-217.15862v-130.824827h217.15862v130.824827z m0 170.301793h-217.15862v-138.169379h217.15862v138.169379z M917.645241 144.772414a70.62069 70.62069 0 0 1 70.62069 70.620689v681.489656a70.62069 70.62069 0 0 1-70.62069 70.620689H94.384552a70.62069 70.62069 0 0 1-70.62069-70.620689V215.393103a70.62069 70.62069 0 0 1 70.62069-70.620689h823.260689z m0 45.903448H94.384552a24.717241 24.717241 0 0 0-24.50538 21.362759l-0.211862 3.354482v681.489656a24.717241 24.717241 0 0 0 21.362759 24.505379l3.354483 0.211862h823.260689a24.717241 24.717241 0 0 0 24.50538-21.362759l0.211862-3.354482V215.393103a24.717241 24.717241 0 0 0-21.362759-24.505379l-3.354483-0.211862z M312.214069 31.249655a22.951724 22.951724 0 0 1 22.704552 19.561931l0.247172 3.389793v180.824276a22.951724 22.951724 0 0 1-45.656276 3.389793l-0.247172-3.389793v-180.788965a22.951724 22.951724 0 0 1 22.951724-22.951724zM691.023448 31.249655a22.951724 22.951724 0 0 1 22.704552 19.561931l0.247172 3.389793v180.824276a22.951724 22.951724 0 0 1-45.656275 3.389793l-0.247173-3.389793v-180.788965a22.951724 22.951724 0 0 1 22.951724-22.951724z",
                    onclick:()=>{
                                  this.getDay();                                  }
                    },
                myTool2:{
                    show:true,
                    title:'月榜数据',
                    icon:"path://M371.959172 792.328828c29.837241-39.017931 47.315862-88.134621 52.788966-147.809104h197.843862v91.347862c0 13.312-5.508414 20.197517-16.066207 20.197517-17.44331 0-36.722759-0.918069-57.838345-1.836137l9.18069 32.591448h59.215448c25.705931 0 39.017931-13.312 39.017931-39.476966V388.378483h-263.026758v224.008827c-0.918069 63.346759-16.066207 115.67669-46.362483 156.989793l25.246896 22.951725z m250.632828-291.945931h-195.972414v-80.331035h195.972414v80.331035z m0 113.381517h-195.972414v-82.626207h195.972414v82.626207z M917.645241 144.772414a70.62069 70.62069 0 0 1 70.62069 70.620689v681.489656a70.62069 70.62069 0 0 1-70.62069 70.620689H94.384552a70.62069 70.62069 0 0 1-70.62069-70.620689V215.393103a70.62069 70.62069 0 0 1 70.62069-70.620689h823.260689z m0 45.903448H94.384552a24.717241 24.717241 0 0 0-24.50538 21.362759l-0.211862 3.354482v681.489656a24.717241 24.717241 0 0 0 21.362759 24.505379l3.354483 0.211862h823.260689a24.717241 24.717241 0 0 0 24.50538-21.362759l0.211862-3.354482V215.393103a24.717241 24.717241 0 0 0-21.362759-24.505379l-3.354483-0.211862z M312.214069 31.249655a22.951724 22.951724 0 0 1 22.704552 19.561931l0.247172 3.389793v180.824276a22.951724 22.951724 0 0 1-45.656276 3.389793l-0.247172-3.389793v-180.788965a22.951724 22.951724 0 0 1 22.951724-22.951724zM691.023448 31.249655a22.951724 22.951724 0 0 1 22.704552 19.561931l0.247172 3.389793v180.824276a22.951724 22.951724 0 0 1-45.656275 3.389793l-0.247173-3.389793v-180.788965a22.951724 22.951724 0 0 1 22.951724-22.951724z",
                    onclick:()=>{
                                  this.getMonth();                                  }
                    },
                myTool3:{
                    show:true,
                    title:'排序',
                    icon:"path://M393.841 0c-19.262 0-34.889 15.604-34.889 34.889v869.407L138.92 684.265c-13.628-13.629-35.707-13.606-49.335 0-13.605 13.628-13.628 35.706 0 49.357l279.612 279.589c0.022 0.022 0.045 0.022 0.068 0.045a34.805 34.805 0 0 0 11.266 7.496c0.272 0.091 0.522 0.137 0.795 0.228 3.816 1.476 7.927 2.362 12.266 2.407 0.182 0 0.364-0.022 0.545-0.022 4.293-0.022 8.381-0.909 12.175-2.362 0.295-0.113 0.59-0.159 0.909-0.272a35.124 35.124 0 0 0 11.016-7.314c0.091-0.091 0.205-0.113 0.295-0.204s0.114-0.204 0.182-0.296a34.762 34.762 0 0 0 7.359-11.062c0.091-0.25 0.136-0.499 0.227-0.749 1.5-3.885 2.408-8.063 2.408-12.471 0-0.045 0.023-0.091 0.023-0.136V34.889C428.73 15.604 413.103 0 393.841 0zM932.258 289.901L652.646 10.29c-0.023-0.045-0.046-0.045-0.068-0.045a35.188 35.188 0 0 0-11.267-7.496c-0.272-0.091-0.522-0.136-0.795-0.227A34.373 34.373 0 0 0 628.25 0.114h-0.545c-4.293 0.045-8.382 0.908-12.175 2.362-0.295 0.137-0.591 0.182-0.908 0.318-4.135 1.681-7.859 4.179-11.017 7.269-0.091 0.091-0.205 0.136-0.296 0.227s-0.113 0.182-0.182 0.272c-3.111 3.18-5.633 6.905-7.359 11.084-0.091 0.227-0.136 0.5-0.227 0.727-1.499 3.907-2.408 8.086-2.408 12.493 0 0.045-0.022 0.091-0.022 0.136v953.631c0 19.262 15.627 34.89 34.889 34.89s34.89-15.628 34.89-34.89V119.227l220.031 220.01c13.629 13.628 35.707 13.628 49.336 0 13.606-13.63 13.629-35.708 0.001-49.336z",
                    onclick:()=>{
                                  this.sortData("up");                                  }
                    },
            });
            this.initData([]);
            this.ws_int();
        },
        data(){
            return{
                day:[],
                month:[],
            }
        },
        methods: {
            ws_int() {
                if (typeof(WebSocket) === "undefined") {
                    alert("您的浏览器不支持socket");
                } else {
                    var socket = new WebSocket('ws://localhost:3000/ws?uid=123');
                    var wsping = setInterval(function() {
                        socket.send("ping")
                    }, 5000);
                    this.get_prototype.$ws = {};
                    this.get_prototype.$ws.ws = socket;
                    this.get_prototype.$ws.wsping = wsping;
                    socket.onopen = this.ws_onpen;
                    socket.onmessage = this.ws_message;
                    socket.onclose = this.ws_close;
                }
            },
            ws_onpen({target}){
                target.send(JSON.stringify({name:"day"}))
            },
            ws_message(msg) {
                if (msg.data == "pong") {
                    return;
                }
                var list_data = JSON.parse(msg.data);
                if(list_data.name == "day"){
                    this.day = list_data.list;
                    this.setData(list_data.list);
                    
                }
                if(list_data.name == "month"){
                    this.month = list_data.list;
                    this.setData(list_data.list);
                }
            },
            ws_close() {
                clearInterval(this.$ws.wsping);
            },
            initData(int_data) {
                this.$refs.bar.initDataByObject(int_data, {
                    x: "time",
                    type:"bar",
                    y: 'view'
                }, 'iw');
            },
            getMonth(){
               this.$ws.ws.send(JSON.stringify({name:"month"}))
            },
            getDay(){
               this.$ws.ws.send(JSON.stringify({name:"day"}))
            },
            setData(set_data) {
                this.$refs.bar.setDataByObject(set_data, {
                    x: "time",
                    y: 'view'
                }, 'iw');
                this.$refs.bar.setTempList("iw",(v)=>{
                    var now_time =+ new Date();
                    var upload_time =+ new Date(v.time);
                    var time_hour = (now_time - upload_time)/(1000*60*60);
                    return v.value/time_hour;
                },'line') 
            },
            sortData(way) {
                this.$refs.bar.sortData("iw", way);
            },
            backData() {
                this.$refs.bar.restartData("iw");
            }
        }
    }
</script>

<style>
</style>
